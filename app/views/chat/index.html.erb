<% content_for :title, "Chat con #{@agent.name}" %>

<div class="chat-container card">
  <div class="chat-messages" id="messages">
    <div class="message message-agent">
      <strong>ğŸ• <%= @agent.name %>:</strong><br>
      Â¡Hola! Soy <%= @agent.name %>, tu asistente de ITLab. Â¿En quÃ© puedo ayudarte hoy?
    </div>
  </div>
  
  <div class="chat-input-container">
    <input 
      type="text" 
      class="form-input chat-input" 
      id="message-input"
      placeholder="Escribe tu mensaje..."
      autocomplete="off"
    >
    <button class="btn btn-primary" id="send-btn">Enviar</button>
  </div>
  
  <div id="connection-status" style="padding: 0.5rem 1rem; font-size: 0.75rem; color: var(--text-muted); border-top: 1px solid var(--border);">
    <span class="pill pill-warning">Conectando...</span>
  </div>
</div>

<script>
  const agentId = '<%= @agent.id %>';
  const messagesDiv = document.getElementById('messages');
  const input = document.getElementById('message-input');
  const sendBtn = document.getElementById('send-btn');
  const statusDiv = document.getElementById('connection-status');
  
  let cable = null;
  let chatChannel = null;

  // Conectar a ActionCable
  function connectWebSocket() {
    statusDiv.innerHTML = '<span class="pill pill-warning">Conectando...</span>';
    
    cable = ActionCable.createConsumer('/cable');
    
    chatChannel = cable.subscriptions.create('ChatChannel', {
      agent_id: agentId
    }, {
      connected: function() {
        statusDiv.innerHTML = '<span class="pill pill-success">â— Conectado (Tiempo Real)</span>';
        console.log('Conectado al chat');
      },
      disconnected: function() {
        statusDiv.innerHTML = '<span class="pill pill-danger">Desconectado</span>';
      },
      received: function(data) {
        if (data.type === 'message') {
          if (data.user_message) {
            addMessage(data.user_message.content, 'user');
          }
          if (data.assistant_message) {
            addMessage(data.assistant_message.content, 'agent');
          }
        }
      }
    });
  }

  function addMessage(text, sender) {
    const div = document.createElement('div');
    div.className = 'message message-' + sender;
    const label = sender === 'user' ? 'ğŸ‘¤ TÃº:' : 'ğŸ• Spot:';
    div.innerHTML = '<strong>' + label + '</strong><br>' + text;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  function sendMessage() {
    const text = input.value.trim();
    if (!text) return;
    
    input.disabled = true;
    sendBtn.disabled = true;
    
    // Usar WebSocket si estÃ¡ conectado, si no usar HTTP
    if (chatChannel && statusDiv.innerHTML.includes('Conectado')) {
      chatChannel.perform('chat', { message: text, agent_id: agentId });
      // El mensaje se agregarÃ¡ cuando llegue la respuesta
      addMessage(text, 'user');
      input.value = '';
      input.disabled = false;
      sendBtn.disabled = false;
      input.focus();
    } else {
      // Fallback a HTTP
      fetch('/api/agents/' + agentId + '/chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({ message: text, channel: 'web' })
      })
      .then(res => res.json())
      .then(data => {
        if (data.assistant_message) {
          addMessage(data.assistant_message.content, 'agent');
        }
      })
      .catch(err => {
        console.error('Error:', err);
        addMessage('Error al enviar mensaje.', 'agent');
      })
      .finally(() => {
        input.disabled = false;
        sendBtn.disabled = false;
        input.focus();
      });
    }
  }

  sendBtn.addEventListener('click', sendMessage);
  input.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage();
  });

  // Conectar al cargar
  connectWebSocket();

  messagesDiv.scrollTop = messagesDiv.scrollHeight;
</script>
